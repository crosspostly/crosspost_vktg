name: CI/CD VKTelegram Crossposter

on:
  push:
    branches:
      - main
      - refactor-split-client-server-modules-limit-500-lines-glasp-apps-script
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      working-directory: ./glasp
      run: |
        echo "ğŸ”§ Installing dependencies in glasp directory..."
        npm ci
        echo "âœ… Dependencies installed successfully"

    - name: Build Server
      run: |
        echo "ğŸ—ï¸ Building server bundle..."
        node glasp/deploy-server.js
        echo "âœ… Server build completed"
        if [ -f "dist/server-bundle.gs" ]; then
          echo "ğŸ“„ Server bundle created: $(wc -l < dist/server-bundle.gs) lines"
        else
          echo "âŒ Server bundle not found"
          exit 1
        fi

    - name: Build Client
      run: |
        echo "ğŸ—ï¸ Building client bundle..."
        node glasp/deploy-client.js
        echo "âœ… Client build completed"
        if [ -f "dist/client-bundle.gs" ]; then
          echo "ğŸ“„ Client bundle created: $(wc -l < dist/client-bundle.gs) lines"
        else
          echo "âŒ Client bundle not found"
          exit 1
        fi

    # Uncomment for auto-deploy if clasp/account is ready
    #- name: Deploy server
    #  run: node glasp/deploy-server.js --deploy
    #- name: Deploy client
    #  run: node glasp/deploy-client.js --deploy

    - name: Upload dist as artifact
      run: |
        echo "ğŸ“¦ Preparing to upload dist artifacts..."
        echo "ğŸ“ Contents of dist directory:"
        ls -la dist/
        echo "ğŸ“Š Total size: $(du -sh dist/ | cut -f1)"
      uses: actions/upload-artifact@v4
      with:
        name: dist-apps-script
        path: dist/
        retention-days: 30
    
    - name: Lint scripts
      run: |
        echo "ğŸ” Running ESLint on server and client scripts..."
        npm install -g eslint
        echo "ğŸ“ Server files to lint:"
        ls -la server/*.gs 2>/dev/null || echo "No server .gs files found"
        echo "ğŸ“ Client files to lint:"
        ls -la client/*.gs 2>/dev/null || echo "No client .gs files found"
        echo "ğŸ” Running ESLint..."
        eslint server/*.gs client/*.gs || echo "âš ï¸ ESLint found issues (continuing anyway)"

    - name: Summary glasp modules
      run: |
        echo "ğŸ“‹ === BUILD SUMMARY ==="
        echo ""
        echo "ğŸ–¥ï¸ Node.js version: $(node --version)"
        echo "ğŸ“¦ NPM version: $(npm --version)"
        echo ""
        echo "ğŸ“ Server modules:"
        ls -al server/ || echo "No server directory found"
        echo ""
        echo "ğŸ“ Client modules:"
        ls -al client/ || echo "No client directory found"
        echo ""
        echo "ğŸ“¦ Distribution build:"
        ls -al dist/ || echo "No dist directory found"
        echo ""
        echo "ğŸ“Š Build artifacts info:"
        if [ -f "dist/server-bundle.gs" ]; then
          echo "  âœ… Server bundle: $(wc -l < dist/server-bundle.gs) lines"
        else
          echo "  âŒ Server bundle: NOT FOUND"
        fi
        if [ -f "dist/client-bundle.gs" ]; then
          echo "  âœ… Client bundle: $(wc -l < dist/client-bundle.gs) lines"
        else
          echo "  âŒ Client bundle: NOT FOUND"
        fi
        echo ""
        echo "ğŸ‰ Build & packed by crosspostly-bot"

    - name: Final workflow status
      if: always()
      run: |
        echo "ğŸ === WORKFLOW COMPLETION STATUS ==="
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… All steps completed successfully!"
        else
          echo "âŒ Workflow encountered issues"
        fi
        echo "ğŸ“… Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
