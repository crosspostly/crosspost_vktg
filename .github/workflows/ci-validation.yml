name: CI Configuration Validation

on:
  pull_request:
    branches: [main]
    paths:
      - '.github/workflows/**'
      - 'glasp/package.json'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  validate-workflows:
    name: "ðŸ”§ Validate CI Configuration"
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: glasp/package.json
        
    - name: Install dependencies
      working-directory: ./glasp
      run: npm ci
      
    - name: Validate workflow syntax
      run: |
        echo "ðŸ”§ Validating workflow files..."
        
        # Check all workflow files for valid YAML
        for workflow in .github/workflows/*.yml; do
          echo "  ðŸ“ Checking $workflow"
          if python3 -c "import yaml; yaml.safe_load(open('$workflow'))" 2>/dev/null; then
            echo "    âœ… Valid YAML"
          else
            echo "    âŒ Invalid YAML"
            exit 1
          fi
        done
        
    - name: Validate npm scripts
      working-directory: ./glasp
      run: |
        echo "ðŸ“œ Validating npm scripts..."
        
        # Test each script exists and can be called
        scripts=("lint" "module-check" "build:server" "build:client" "build" "test")
        
        for script in "${scripts[@]}"; do
          echo "  ðŸ§ª Testing npm run $script"
          if npm run | grep -q "$script"; then
            echo "    âœ… Script defined"
          else
            echo "    âŒ Script not defined"
            exit 1
          fi
        done
        
    - name: Test module integrity script
      working-directory: ./glasp
      run: |
        echo "ðŸ§© Testing module integrity check..."
        npm run module-check
        
    - name: Test build scripts (dry run)
      working-directory: ./glasp
      run: |
        echo "ðŸ—ï¸ Testing build scripts..."
        
        # Test server build
        echo "  ðŸ”¨ Testing server build..."
        if npm run build:server; then
          echo "    âœ… Server build successful"
          if [ -f "dist/server-bundle.gs" ]; then
            echo "    âœ… Server bundle created"
          else
            echo "    âŒ Server bundle missing"
            exit 1
          fi
        else
          echo "    âŒ Server build failed"
          exit 1
        fi
        
        # Test client build
        echo "  ðŸ”¨ Testing client build..."
        if npm run build:client; then
          echo "    âœ… Client build successful"
          if [ -f "dist/client-bundle.gs" ]; then
            echo "    âœ… Client bundle created"
          else
            echo "    âŒ Client bundle missing"
            exit 1
          fi
        else
          echo "    âŒ Client build failed"
          exit 1
        fi
        
    - name: Validate workflow triggers
      run: |
        echo "ðŸŽ¯ Validating workflow triggers..."
        
        # Check that ci.yml has proper triggers
        echo "  ðŸ“‹ Checking ci.yml triggers..."
        if grep -q "pull_request:" .github/workflows/ci.yml && grep -q "push:" .github/workflows/ci.yml; then
          echo "    âœ… CI triggers configured"
        else
          echo "    âŒ CI triggers missing"
          exit 1
        fi
        
        # Check that quick-check.yml has proper triggers  
        echo "  âš¡ Checking quick-check.yml triggers..."
        if grep -q "push:" .github/workflows/quick-check.yml; then
          echo "    âœ… Quick check triggers configured"
        else
          echo "    âŒ Quick check triggers missing"
          exit 1
        fi
        
    - name: Validate permissions
      run: |
        echo "ðŸ” Validating workflow permissions..."
        
        # Check that workflows don't request excessive permissions
        workflows=("ci.yml" "quick-check.yml" "maintenance.yml" "ci-validation.yml")
        
        for workflow in "${workflows[@]}"; do
          echo "  ðŸ”’ Checking $workflow permissions..."
          if grep -A 10 "permissions:" ".github/workflows/$workflow" | grep -q "write"; then
            echo "    âš ï¸  Contains write permissions (review if needed)"
          else
            echo "    âœ… Minimal permissions"
          fi
        done
        
    - name: Generate validation report
      run: |
        echo "# ðŸ”§ CI Configuration Validation Report" > validation-report.md
        echo "" >> validation-report.md
        echo "## Validation Results" >> validation-report.md
        echo "- âœ… Workflow YAML syntax: Valid" >> validation-report.md
        echo "- âœ… NPM scripts configuration: Valid" >> validation-report.md
        echo "- âœ… Module integrity check: Working" >> validation-report.md
        echo "- âœ… Build scripts: Functional" >> validation-report.md
        echo "- âœ… Workflow triggers: Configured" >> validation-report.md
        echo "- âœ… Permissions: Minimal and appropriate" >> validation-report.md
        echo "" >> validation-report.md
        echo "## Summary" >> validation-report.md
        echo "ðŸŽ‰ **CI configuration is valid and ready for use!**" >> validation-report.md
        
    - name: Upload validation report
      uses: actions/upload-artifact@v4
      with:
        name: ci-validation-report
        path: validation-report.md
        retention-days: 30