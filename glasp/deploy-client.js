/**
 * Build script Ð´Ð»Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ñ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹
 * ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÑÐµÑ‚ Ð²ÑÐµ client/*.gs Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ð¾Ð´Ð¸Ð½ bundle Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
 */

const fs = require('fs');
const path = require('path');

const CLIENT_DIR = path.join(__dirname, '..', 'client');
const DIST_DIR = path.join(__dirname, '..', 'dist');
const OUTPUT_FILE = path.join(DIST_DIR, 'client-bundle.gs');

console.log('ðŸš€ Building client bundle...');

// Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ dist Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
if (!fs.existsSync(DIST_DIR)) {
  fs.mkdirSync(DIST_DIR, { recursive: true });
  console.log('  âœ“ Created dist/ directory');
}

// ÐŸÐ¾Ñ€ÑÐ´Ð¾Ðº Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹
const modules = [
  'client-core.gs',   // ÐšÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹, Ð¼ÐµÐ½ÑŽ, Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
  'client-dev.gs'     // API Ð²Ñ‹Ð·Ð¾Ð²Ñ‹, Ñ‚ÐµÑÑ‚Ñ‹
];

let bundle = '// VKâ†’Telegram Crossposter - Client Bundle\n';
bundle += '// Auto-generated by glasp/deploy-client.js\n';
bundle += `// Build date: ${new Date().toISOString()}\n`;
bundle += `// Version: 6.1\n\n`;

let totalLines = 0;
let includedModules = 0;

modules.forEach(module => {
  const filePath = path.join(CLIENT_DIR, module);
  
  if (fs.existsSync(filePath)) {
    console.log(`  âœ“ Including ${module}`);
    const content = fs.readFileSync(filePath, 'utf8');
    const lines = content.split('\n').length;
    totalLines += lines;
    includedModules++;
    
    bundle += `\n// ============================================\n`;
    bundle += `// MODULE: ${module} (${lines} lines)\n`;
    bundle += `// ============================================\n\n`;
    bundle += content + '\n';
    
    console.log(`    Lines: ${lines}`);
  } else {
    console.warn(`  âš  Warning: ${module} not found, skipping`);
  }
});

fs.writeFileSync(OUTPUT_FILE, bundle, 'utf8');

console.log('\nâœ… Client bundle created successfully!');
console.log(`ðŸ“¦ Output: ${OUTPUT_FILE}`);
console.log(`ðŸ“Š Statistics:`);
console.log(`   - Modules included: ${includedModules}/${modules.length}`);
console.log(`   - Total lines: ${totalLines}`);
console.log(`   - Bundle size: ${Math.round(bundle.length / 1024)} KB`);

if (includedModules < modules.length) {
  console.warn('\nâš ï¸  Warning: Some modules were not found!');
  process.exit(1);
}