/**
 * Build script Ð´Ð»Ñ ÑÐµÑ€Ð²ÐµÑ€Ð½Ñ‹Ñ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹
 * ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÑÐµÑ‚ Ð²ÑÐµ server/*.gs Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ð¾Ð´Ð¸Ð½ bundle Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
 */

const fs = require('fs');
const path = require('path');

const SERVER_DIR = path.join(__dirname, '..', 'server');
const DIST_DIR = path.join(__dirname, '..', 'dist');
const OUTPUT_FILE = path.join(DIST_DIR, 'server-bundle.gs');

console.log('ðŸš€ Building server bundle...');

// Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ dist Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
if (!fs.existsSync(DIST_DIR)) {
  fs.mkdirSync(DIST_DIR, { recursive: true });
  console.log('  âœ“ Created dist/ directory');
}

// ÐŸÐ¾Ñ€ÑÐ´Ð¾Ðº Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ (Ð²Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹)
const modules = [
  'utils.gs',              // 1. Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹ (Ð±ÐµÐ· Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹)
  'server.gs',             // 2. ÐšÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ñ‹ Ð¸ Ð³Ð»Ð°Ð²Ð½Ñ‹Ð¹ entry point
  'license-service.gs',    // 3. Ð›Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸
  'bindings-service.gs',   // 4. Ð¡Ð²ÑÐ·ÐºÐ¸
  'published-sheets-service.gs', // 5. Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð»Ð¸ÑÑ‚Ð°Ð¼Ð¸
  'vk-api.gs',             // 6a. VK API Ð²Ñ‹Ð·Ð¾Ð²Ñ‹
  'vk-posts.gs',           // 6b. Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾ÑÑ‚Ð¾Ð²
  'vk-media.gs',           // 6c. ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¼ÐµÐ´Ð¸Ð°
  'telegram-service.gs',   // 7. Telegram API
  'posting-service.gs'     // 8. ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ (Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ð²ÑÐµÑ…)
];

let bundle = '// VKâ†’Telegram Crossposter - Server Bundle\n';
bundle += '// Auto-generated by glasp/deploy-server.js\n';
bundle += `// Build date: ${new Date().toISOString()}\n`;
bundle += `// Version: 6.1\n\n`;

let totalLines = 0;
let includedModules = 0;

modules.forEach(module => {
  const filePath = path.join(SERVER_DIR, module);
  
  if (fs.existsSync(filePath)) {
    console.log(`  âœ“ Including ${module}`);
    const content = fs.readFileSync(filePath, 'utf8');
    const lines = content.split('\n').length;
    totalLines += lines;
    includedModules++;
    
    bundle += `\n// ============================================\n`;
    bundle += `// MODULE: ${module} (${lines} lines)\n`;
    bundle += `// ============================================\n\n`;
    bundle += content + '\n';
    
    console.log(`    Lines: ${lines}`);
  } else {
    console.warn(`  âš  Warning: ${module} not found, skipping`);
  }
});

fs.writeFileSync(OUTPUT_FILE, bundle, 'utf8');

console.log('\nâœ… Server bundle created successfully!');
console.log(`ðŸ“¦ Output: ${OUTPUT_FILE}`);
console.log(`ðŸ“Š Statistics:`);
console.log(`   - Modules included: ${includedModules}/${modules.length}`);
console.log(`   - Total lines: ${totalLines}`);
console.log(`   - Bundle size: ${Math.round(bundle.length / 1024)} KB`);

if (includedModules < modules.length) {
  console.warn('\nâš ï¸  Warning: Some modules were not found!');
  process.exit(1);
}