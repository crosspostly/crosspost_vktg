# üìö LIBRARY EXTRACTION PLAN ‚Üí –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –ú–û–î–£–õ–ï–ô

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 6 –Ω–æ—è–±—Ä—è 2025, 07:00 MSK
**–ò—Å—Ç–æ—á–Ω–∏–∫:** crosspost_vktg v6.0 Production-Ready codebase
**–¶–µ–ª—å:** –ò–∑–≤–ª–µ—á—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
**–ü—Ä–∏–Ω—Ü–∏–ø:** –°–æ–∑–¥–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –≥–æ—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

---

## üéØ –ö–û–ù–¶–ï–ü–¶–ò–Ø

### **–û—Ç –º–æ–Ω–æ–ª–∏—Ç–∞ –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ**

–¢–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç **crosspost_vktg** —Å–æ–¥–µ—Ä–∂–∏—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö:
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è  
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å Google Sheets
- ‚úÖ VK API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ Telegram API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- ‚úÖ Published/Sent tracking —Å–∏—Å—Ç–µ–º–∞

**–ó–ê–î–ê–ß–ê:** –ù–µ —Ä–∞–∑–±–∏–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç –Ω–∞ –º–æ–¥—É–ª–∏, –∞ **–ò–ó–í–õ–ï–ß–¨** –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É.

---

## üìÅ –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ë–ò–ë–õ–ò–û–¢–ï–ö–ò

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è:**

```
gas-reusable-lib/  (Google Apps Script Reusable Library)
‚îú‚îÄ‚îÄ core/              # –ë–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ gas-logger.gs
‚îÇ   ‚îú‚îÄ‚îÄ gas-sheets-manager.gs
‚îÇ   ‚îú‚îÄ‚îÄ gas-validator.gs
‚îÇ   ‚îú‚îÄ‚îÄ gas-cache-manager.gs
‚îÇ   ‚îî‚îÄ‚îÄ gas-utils.gs
‚îú‚îÄ‚îÄ integrations/      # API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ vk-api-client.gs
‚îÇ   ‚îú‚îÄ‚îÄ telegram-api-client.gs
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ storage/           # –°–∏—Å—Ç–µ–º—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ published-tracker.gs
‚îÇ   ‚îú‚îÄ‚îÄ bindings-manager.gs
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ auth/              # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ license-system.gs
‚îÇ   ‚îú‚îÄ‚îÄ token-manager.gs
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ templates/         # –ì–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã
‚îÇ   ‚îú‚îÄ‚îÄ crossposting-template.gs
‚îÇ   ‚îú‚îÄ‚îÄ bot-template.gs
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ README.md          # –ì–ª–∞–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

---

## üîß –ú–û–î–£–õ–ò –î–õ–Ø –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø

### **1. CORE UTILITIES**

#### **–ú–æ–¥—É–ª—å: `gas-logger.gs`**

**–ß—Ç–æ –∏–∑–≤–ª–µ—á—å –∏–∑ crosspost_vktg:**
```javascript
// –ò–∑ utils.gs –∏ license-service.gs:
function logEvent(level, event, user, details, ip)
function logApiError(service, endpoint, request, response)
function cleanOldLogs()
// + –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Logs –ª–∏—Å—Ç–∞
```

**–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è:**
```javascript
/**
 * Universal Logger for Google Apps Script
 * Supports multiple logging levels and automatic cleanup
 */
class GASLogger {
  constructor(config = {}) {
    this.sheetName = config.sheetName || 'Logs';
    this.retention = config.retention || 30; // days
    this.levels = config.levels || ['INFO', 'WARN', 'ERROR', 'DEBUG'];
    this.maxRows = config.maxRows || 10000;
  }
  
  /**
   * Log event with level, user, and details
   */
  log(level, event, user, details, ip = null) {
    const sheet = this._getOrCreateSheet();
    const timestamp = new Date();
    
    sheet.appendRow([
      timestamp,
      level,
      event,
      user || 'system',
      JSON.stringify(details),
      ip || this._getClientIp()
    ]);
    
    // Auto-cleanup if needed
    if (sheet.getLastRow() > this.maxRows) {
      this.clean(this.retention);
    }
  }
  
  /**
   * Log API errors with request/response details
   */
  error(service, endpoint, request, response) {
    this.log('ERROR', `${service}_api_error`, 'system', {
      endpoint: endpoint,
      request: request,
      response: response,
      timestamp: new Date().toISOString()
    });
  }
  
  /**
   * Clean logs older than N days
   */
  clean(days = this.retention) {
    const sheet = SpreadsheetApp.getActiveSpreadsheet()
      .getSheetByName(this.sheetName);
    if (!sheet) return;
    
    const data = sheet.getDataRange().getValues();
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);
    
    let deleteCount = 0;
    for (let i = data.length - 1; i >= 1; i--) {
      if (new Date(data[i][0]) < cutoffDate) {
        sheet.deleteRow(i + 1);
        deleteCount++;
      }
    }
    
    return { deleted: deleteCount, remaining: sheet.getLastRow() - 1 };
  }
  
  _getOrCreateSheet() {
    // Implementation...
  }
  
  _getClientIp() {
    // Implementation...
  }
}

// Factory function for easy usage
function createLogger(config) {
  return new GASLogger(config);
}
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö:**
- –õ—é–±–æ–π Apps Script –ø—Ä–æ–µ–∫—Ç —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ API
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø–∞–Ω–µ–ª–∏
- –°–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```javascript
// –í –Ω–æ–≤–æ–º –ø—Ä–æ–µ–∫—Ç–µ:
const logger = createLogger({ 
  sheetName: 'AppLogs',
  retention: 60 
});

logger.log('INFO', 'user_login', userId, { action: 'login_success' });
logger.error('VK_API', '/wall.get', request, response);
```

---

#### **–ú–æ–¥—É–ª—å: `gas-sheets-manager.gs`**

**–ß—Ç–æ –∏–∑–≤–ª–µ—á—å:**
```javascript
function createSheet(name, headers)
function getSheet(name)
function ensureSheetExists(name, headers)
function sanitizeSheetName(name)
// + Auto-migration –ª–æ–≥–∏–∫–∞ –∏–∑ bindings
```

**–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è:**
```javascript
class GASSheetsManager {
  constructor(spreadsheet = SpreadsheetApp.getActiveSpreadsheet()) {
    this.ss = spreadsheet;
  }
  
  /**
   * Create sheet with headers and formatting
   */
  create(name, headers, formatting = {}) {
    const safeName = this.sanitizeName(name);
    let sheet = this.ss.getSheetByName(safeName);
    
    if (!sheet) {
      sheet = this.ss.insertSheet(safeName);
      if (headers && headers.length > 0) {
        sheet.appendRow(headers);
        // Apply formatting
        const headerRange = sheet.getRange(1, 1, 1, headers.length);
        headerRange.setFontWeight('bold');
        headerRange.setBackground(formatting.headerBg || '#4285f4');
        headerRange.setFontColor(formatting.headerColor || '#ffffff');
      }
    }
    return sheet;
  }
  
  /**
   * Auto-migrate sheet structure
   */
  migrate(sheetName, targetColumns) {
    const sheet = this.ss.getSheetByName(sheetName);
    if (!sheet || sheet.getLastRow() === 0) return false;
    
    const currentHeaders = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const missingColumns = targetColumns.filter(col => !currentHeaders.includes(col));
    
    if (missingColumns.length > 0) {
      const lastCol = sheet.getLastColumn();
      missingColumns.forEach((col, index) => {
        sheet.getRange(1, lastCol + index + 1).setValue(col);
      });
      return { migrated: true, added: missingColumns };
    }
    return { migrated: false };
  }
  
  /**
   * Batch operations for performance
   */
  batchWrite(sheetName, data, startRow = 2) {
    const sheet = this.get(sheetName);
    if (!sheet || data.length === 0) return;
    
    const range = sheet.getRange(startRow, 1, data.length, data[0].length);
    range.setValues(data);
  }
  
  get(name) {
    return this.ss.getSheetByName(name);
  }
  
  sanitizeName(name) {
    return name.replace(/[\[\]\*\?\/\\:]/g, '_').substring(0, 100);
  }
}
```

---

### **2. INTEGRATIONS**

#### **–ú–æ–¥—É–ª—å: `vk-api-client.gs`** ‚≠ê **–ö–õ–Æ–ß–ï–í–û–ô –ú–û–î–£–õ–¨**

**–ß—Ç–æ –∏–∑–≤–ª–µ—á—å:**
```javascript
// VK API –º–µ—Ç–æ–¥—ã:
getVkPosts(groupId, count)
getVkMediaUrls(attachments) 
getVkVideoDirectUrl(videoId)  // ‚ö° –£–Ω–∏–∫–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è!
getBestPhotoUrl(sizes)

// Utilities:
extractVkGroupId(url)
resolveVkScreenName(screenName)
getVkGroupName(groupId)
formatVkTextForTelegram(text)
processVkLinks(text)
```

**–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è:**
```javascript
class VKClient {
  constructor(userToken, apiVersion = '5.131') {
    this.token = userToken;
    this.version = apiVersion;
    this.baseUrl = 'https://api.vk.com/method';
    this.cache = new Map();
  }
  
  // Group methods
  groups = {
    getById: (groupId) => this._call('groups.getById', { group_id: Math.abs(groupId) }),
    
    getWall: (groupId, options = {}) => {
      const params = {
        owner_id: groupId,
        count: options.count || 10,
        offset: options.offset || 0,
        filter: options.filter || 'all'
      };
      return this._call('wall.get', params);
    },
    
    resolve: (screenName) => {
      return this._call('utils.resolveScreenName', { screen_name: screenName });
    }
  };
  
  // Video methods - KEY FEATURE!
  video = {
    get: (videoId, ownerId) => {
      const params = { videos: `${ownerId}_${videoId}` };
      return this._call('video.get', params);
    },
    
    /**
     * Get direct video URL - unique feature from crosspost_vktg!
     * Finds the best quality available
     */
    getDirectUrl: async (videoId) => {
      try {
        const [ownerId, postId] = videoId.split('_');
        const response = await this.get(postId, ownerId);
        
        if (!response || !response.items || response.items.length === 0) {
          return null;
        }
        
        const video = response.items[0];
        const qualities = ['player', 'mp4_1080', 'mp4_720', 'mp4_480', 'mp4_360', 'mp4_240'];
        
        for (const quality of qualities) {
          if (video.files && video.files[quality]) {
            return video.files[quality];
          }
        }
        
        return video.player || null;
      } catch (error) {
        Logger.log(`VK Video URL error: ${error.message}`);
        return null;
      }
    }
  };
  
  // Utilities
  utils = {
    extractId: (url) => {
      // Extract VK group/user ID from URL
      const patterns = [
        /vk\.com\/(?:club|public)(\d+)/,
        /vk\.com\/([a-zA-Z0-9_]+)/
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
          if (match[1].match(/^\d+$/)) {
            return -parseInt(match[1]);
          }
          return match[1]; // screen_name
        }
      }
      return null;
    },
    
    formatTextForTelegram: (vkText) => {
      if (!vkText) return '';
      
      let formatted = vkText;
      // Remove VK-specific formatting
      formatted = formatted.replace(/\[club(\d+)\|([^\]]+)\]/g, '$2');
      formatted = formatted.replace(/\[id(\d+)\|([^\]]+)\]/g, '$2');
      // Convert links
      formatted = formatted.replace(/\[([^|]+)\|([^\]]+)\]/g, '$2 ($1)');
      
      return formatted;
    }
  };
  
  // Internal API call method
  async _call(method, params = {}) {
    const url = `${this.baseUrl}/${method}`;
    const payload = {
      ...params,
      access_token: this.token,
      v: this.version
    };
    
    const options = {
      method: 'post',
      payload: payload,
      muteHttpExceptions: true
    };
    
    try {
      const response = UrlFetchApp.fetch(url, options);
      const json = JSON.parse(response.getContentText());
      
      if (json.error) {
        throw new Error(`VK API Error: ${json.error.error_msg}`);
      }
      
      return json.response;
    } catch (error) {
      Logger.log(`VK API call failed: ${error.message}`);
      throw error;
    }
  }
}
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
- –õ—é–±—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ VK ‚Üí –¥—Ä—É–≥–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- VK –±–æ—Ç—ã
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ VK –≥—Ä—É–ø–ø
- –ü–∞—Ä—Å–∏–Ω–≥ VK –∫–æ–Ω—Ç–µ–Ω—Ç–∞
