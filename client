/**
 * VK‚ÜíTelegram Crossposter - CLIENT v6.0 FINAL
 * 
 * ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤—è–∑–∫–∞–º–∏
 * ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä—É
 * ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π –ø–æ—Å—Ç–æ–≤
 * ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π HTML –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
 * ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π
 */

// ============================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================

const DEV_MODE = false; // –í–∫–ª—é—á–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
const CLIENT_VERSION = "6.0";

// üö® –í–ê–ñ–ù–û: –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê URL –í–ê–®–ï–ì–û –°–ï–†–í–ï–†–ê!
// –ü–æ–ª—É—á–∏—Ç–µ —ç—Ç–æ—Ç URL –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Server.gs –∫–∞–∫ Web App
const SERVER_URL = "YOUR_SERVER_URL_HERE";

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
const CACHE_DURATION = 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç –∫–µ—à –¥–ª—è –ª–∏—Ü–µ–Ω–∑–∏–π
const MAX_POSTS_CHECK = 50; // –ú–∞–∫—Å–∏–º—É–º –ø–æ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞ —Ä–∞–∑

// ============================================
// 1. –ú–ï–ù–Æ –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ============================================

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  
  ui.createMenu("VK‚ÜíTelegram")
    .addItem("üöÄ –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è", "openMainPanel")
    .addItem("üß™ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã –≤—Ä—É—á–Ω—É—é", "checkNewPostsManually")
    .addItem("‚öôÔ∏è –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä (30 –º–∏–Ω)", "setupTrigger")
    .addItem("üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É", "showUserStatistics")
    .addItem("üîç –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏", "showLogsSheet")
    .addToUi();
}

function openMainPanel() {
  try {
    const htmlContent = getMainPanelHtml();
    if (!htmlContent) {
      throw new Error("Failed to generate main panel HTML");
    }
    
    const html = HtmlService.createHtmlOutput(htmlContent);
    if (!html) {
      throw new Error("Failed to create HTML output");
    }
    
    html.setWidth(1000).setHeight(700);
    
    SpreadsheetApp.getUi()
      .showModelessDialog(html, "üöÄ VK‚ÜíTelegram Manager v" + CLIENT_VERSION);
      
  } catch (error) {
    logEvent("ERROR", "main_panel_error", "client", error.message);
    SpreadsheetApp.getUi().alert("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏: " + error.message);
  }
}

// ============================================
// 2. –ì–õ–ê–í–ù–´–ô HTML –ò–ù–¢–ï–†–§–ï–ô–°
// ============================================

function getMainPanelHtml() {
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f7fa;
      color: #333;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 40px;
      text-align: center;
    }
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    .content {
      padding: 30px 40px;
      max-width: 1000px;
      margin: 0 auto;
    }
    .section {
      background: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .section h2 {
      font-size: 18px;
      color: #333;
      margin-bottom: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    .section h2 .icon {
      margin-right: 10px;
      font-size: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }
    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #f0f0f0;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    .hint {
      font-size: 12px;
      color: #999;
      margin-top: 6px;
      line-height: 1.4;
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      width: 100%;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102,126,234,0.3);
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
      width: 100%;
    }
    .btn-secondary:hover:not(:disabled) {
      background: #d1d5db;
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      width: auto;
    }
    .btn-success {
      background: #10b981;
      color: white;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    .btn-warning {
      background: #f59e0b;
      color: white;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      display: none;
    }
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    .message.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
      display: block;
    }
    .message.loading {
      background: #e7f3ff;
      color: #004085;
      display: block;
    }
    
    .loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    .loader.show {
      display: flex;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .bindings-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .binding-item {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .binding-item.paused {
      opacity: 0.6;
      background: #fff3cd;
      border-color: #ffeaa7;
    }
    .binding-header {
      display: flex;
      justify-content: between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .binding-info {
      flex: 1;
    }
    .binding-actions {
      display: flex;
      gap: 6px;
      margin-left: 12px;
    }
    .binding-vk {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      word-break: break-all;
    }
    .binding-tg {
      font-size: 12px;
      color: #666;
      font-family: 'Courier New', monospace;
    }
    .binding-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    .status-paused {
      background: #fff3cd;
      color: #856404;
    }
    
    .empty-state {
      text-align: center;
      color: #999;
      padding: 40px 20px;
      font-style: italic;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .license-info {
      background: #e7f3ff;
      border: 1px solid #bee5eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .license-type {
      font-weight: 600;
      color: #004085;
      font-size: 16px;
      margin-bottom: 4px;
    }
    .license-details {
      font-size: 13px;
      color: #004085;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üöÄ VK‚ÜíTelegram Manager</h1>
    <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∫—Ä–æ—Å—Å–ø–æ—Å—Ç–∏–Ω–≥–æ–º</p>
  </div>
  
  <div class="content">
    <!-- Loader -->
    <div id="loader" class="loader">
      <div class="spinner"></div>
    </div>
    
    <!-- License Section -->
    <div class="section" id="license-section">
      <h2><span class="icon">üîë</span>1. –í–∞—à–∞ –ª–∏—Ü–µ–Ω–∑–∏—è</h2>
      <div id="license-message" class="message"></div>
      
      <div id="license-input-form">
        <div class="form-group">
          <label>–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á</label>
          <input type="text" id="license-key-input" placeholder="LICENSE-TRIAL-ABC123-2025-12-31">
          <div class="hint">–ü–æ–ª—É—á–∏—Ç–µ —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–µ—Ä–≤–µ—Ä–∞</div>
        </div>
        <button class="btn-primary" onclick="checkAndSaveLicense()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      
      <div id="license-info" class="license-info" style="display: none;">
        <div class="license-type" id="license-type-display"></div>
        <div class="license-details" id="license-details-display"></div>
      </div>
    </div>
    
    <!-- Bindings Section -->
    <div class="section" id="bindings-section" style="display: none;">
      <h2><span class="icon">üîó</span>2. –í–∞—à–∏ —Å–≤—è–∑–∫–∏ (<span id="bindings-count">0</span>)</h2>
      <div id="bindings-message" class="message"></div>
      
      <div class="stats-grid" id="bindings-stats" style="display: none;">
        <div class="stat-card">
          <div class="stat-value" id="active-bindings">0</div>
          <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="paused-bindings">0</div>
          <div class="stat-label">–ù–∞ –ø–∞—É–∑–µ</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-bindings">0</div>
          <div class="stat-label">–í—Å–µ–≥–æ</div>
        </div>
      </div>
      
      <div id="bindings-list" class="bindings-list"></div>
      
      <button class="btn-secondary" id="add-binding-btn" onclick="showAddBindingDialog()">
        ‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–≤—è–∑–∫—É
      </button>
    </div>
    
    <!-- Status Section -->
    <div class="section" id="status-section" style="display: none;">
      <h2><span class="icon">üìä</span>3. –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h2>
      <div id="status-content"></div>
    </div>
  </div>

<script>
  // ============================================
  // –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
  // ============================================
  
  let appState = {
    license: null,
    bindings: [],
    stats: { active: 0, paused: 0, total: 0 }
  };

  // ============================================
  // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
  // ============================================
  
  document.addEventListener('DOMContentLoaded', function() {
    loadInitialData();
  });

  function loadInitialData() {
    showLoader(true);
    
    google.script.run
      .withSuccessHandler(function(data) {
        showLoader(false);
        
        if (data.success) {
          appState.license = data.license;
          appState.bindings = data.bindings || [];
          updateUI();
        } else {
          showMessage('license', 'error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + data.error);
        }
      })
      .withFailureHandler(function(error) {
        showLoader(false);
        showMessage('license', 'error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
      })
      .getInitialData();
  }

  function updateUI() {
    updateLicenseSection();
    updateBindingsSection();
    updateStatusSection();
  }

  function updateLicenseSection() {
    const licenseInputForm = document.getElementById('license-input-form');
    const licenseInfo = document.getElementById('license-info');
    const licenseTypeDisplay = document.getElementById('license-type-display');
    const licenseDetailsDisplay = document.getElementById('license-details-display');
    
    if (appState.license) {
      licenseInputForm.style.display = 'none';
      licenseInfo.style.display = 'block';
      
      licenseTypeDisplay.textContent = appState.license.type + ' –ª–∏—Ü–µ–Ω–∑–∏—è';
      licenseDetailsDisplay.innerHTML = 
        '–ú–∞–∫—Å–∏–º—É–º —Å–≤—è–∑–æ–∫: <strong>' + appState.license.maxGroups + '</strong><br>' +
        '–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: <strong>' + new Date(appState.license.expires).toLocaleDateString() + '</strong>';
      
      document.getElementById('bindings-section').style.display = 'block';
      document.getElementById('status-section').style.display = 'block';
      
      showMessage('license', 'success', '‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è –∞–∫—Ç–∏–≤–Ω–∞');
    } else {
      licenseInputForm.style.display = 'block';
      licenseInfo.style.display = 'none';
      
      document.getElementById('bindings-section').style.display = 'none';
      document.getElementById('status-section').style.display = 'none';
    }
  }

  function updateBindingsSection() {
    if (!appState.license) return;
    
    const bindings = appState.bindings;
    const activeBindings = bindings.filter(b => b.status === 'active').length;
    const pausedBindings = bindings.filter(b => b.status === 'paused').length;
    
    appState.stats = {
      active: activeBindings,
      paused: pausedBindings,
      total: bindings.length
    };
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
    document.getElementById('bindings-count').textContent = bindings.length;
    document.getElementById('active-bindings').textContent = activeBindings;
    document.getElementById('paused-bindings').textContent = pausedBindings;
    document.getElementById('total-bindings').textContent = bindings.length;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const statsGrid = document.getElementById('bindings-stats');
    if (bindings.length > 0) {
      statsGrid.style.display = 'grid';
    } else {
      statsGrid.style.display = 'none';
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–≤—è–∑–æ–∫
    const bindingsList = document.getElementById('bindings-list');
    
    if (bindings.length === 0) {
      bindingsList.innerHTML = '<div class="empty-state">üì≠ –°–≤—è–∑–∫–∏ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã<br><br>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å–≤—è–∑–∫—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫—Ä–æ—Å—Å–ø–æ—Å—Ç–∏–Ω–≥</div>';
    } else {
      bindingsList.innerHTML = bindings.map(binding => 
        '<div class="binding-item' + (binding.status === 'paused' ? ' paused' : '') + '">' +
          '<div class="binding-header">' +
            '<div class="binding-info">' +
              '<div class="binding-vk">üìò ' + binding.vkGroupUrl + '</div>' +
              '<div class="binding-tg">‚Üí üí¨ ' + binding.tgChatId + '</div>' +
            '</div>' +
            '<div class="binding-actions">' +
              '<button class="btn-small btn-success" onclick="testBinding(\'' + binding.id + '\')" title="–¢–µ—Å—Ç">üöÄ</button>' +
              '<button class="btn-small btn-warning" onclick="toggleBinding(\'' + binding.id + '\')" title="' + (binding.status === 'active' ? '–ü–∞—É–∑–∞' : '–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å') + '">' + (binding.status === 'active' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è') + '</button>' +
              '<button class="btn-small btn-secondary" onclick="editBinding(\'' + binding.id + '\')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>' +
              '<button class="btn-small btn-danger" onclick="deleteBinding(\'' + binding.id + '\')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>' +
            '</div>' +
          '</div>' +
          '<div class="binding-status status-' + binding.status + '">' + binding.status + '</div>' +
        '</div>'
      ).join('');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    const addButton = document.getElementById('add-binding-btn');
    if (bindings.length >= appState.license.maxGroups) {
      addButton.disabled = true;
      addButton.textContent = '‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Å–≤—è–∑–æ–∫';
    } else {
      addButton.disabled = false;
      addButton.textContent = '‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–≤—è–∑–∫—É';
    }
  }

  function updateStatusSection() {
    if (!appState.license) return;
    
    const statusContent = document.getElementById('status-content');
    
    const serverStatus = SERVER_URL === 'YOUR_SERVER_URL_HERE' ? 
      '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω' : '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω';
    
    const triggerStatus = '‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –º–µ–Ω—é "–°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä"';
    
    statusContent.innerHTML = 
      '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">' +
        '<div><strong>–°–µ—Ä–≤–µ—Ä:</strong> ' + serverStatus + '</div>' +
        '<div><strong>–õ–∏—Ü–µ–Ω–∑–∏—è:</strong> ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞</div>' +
        '<div><strong>–°–≤—è–∑–æ–∫:</strong> ' + appState.stats.total + ' (' + appState.stats.active + ' –∞–∫—Ç–∏–≤–Ω—ã—Ö)</div>' +
        '<div><strong>–¢—Ä–∏–≥–≥–µ—Ä:</strong> ' + triggerStatus + '</div>' +
      '</div>' +
      '<div style="margin-top: 16px; padding: 12px; background: #f8f9fa; border-radius: 6px; font-size: 13px; color: #666;">' +
        'üí° <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã –≤ –≤–∞—à–∏—Ö VK –≥—Ä—É–ø–ø–∞—Ö –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ Telegram –∫–∞–Ω–∞–ª—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–¢–µ—Å—Ç" –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–∂–¥–æ–π —Å–≤—è–∑–∫–∏.' +
      '</div>';
  }

  // ============================================
  // –£–ü–†–ê–í–õ–ï–ù–ò–ï –õ–ò–¶–ï–ù–ó–ò–ï–ô
  // ============================================

  function checkAndSaveLicense() {
    const licenseKey = document.getElementById('license-key-input').value.trim();
    
    if (!licenseKey) {
      showMessage('license', 'error', '–í–≤–µ–¥–∏—Ç–µ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á');
      return;
    }
    
    showMessage('license', 'loading', 'üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...');
    showLoader(true);
    
    google.script.run
      .withSuccessHandler(function(result) {
        showLoader(false);
        
        if (result.success) {
          appState.license = result.license;
          updateUI();
          loadBindings();
        } else {
          showMessage('license', 'error', result.error);
        }
      })
      .withFailureHandler(function(error) {
        showLoader(false);
        showMessage('license', 'error', '–û—à–∏–±–∫–∞: ' + error.message);
      })
      .saveLicenseWithCheck(licenseKey);
  }

  // ============================================
  // –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–í–Ø–ó–ö–ê–ú–ò
  // ============================================

  function loadBindings() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          appState.bindings = result.bindings;
          updateBindingsSection();
        }
      })
      .withFailureHandler(function(error) {
        showMessage('bindings', 'error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–æ–∫: ' + error.message);
      })
      .getBindings();
  }

  function showAddBindingDialog() {
    const vkUrl = prompt(
      'üîó –í–≤–µ–¥–∏—Ç–µ URL VK –≥—Ä—É–ø–ø—ã:\\n\\n' +
      '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:\\n' +
      '‚Ä¢ https://vk.com/durov\\n' +
      '‚Ä¢ https://vk.com/public123456\\n' +
      '‚Ä¢ https://vk.com/club123456\\n' +
      '‚Ä¢ vk.com/–∏–º—è_–≥—Ä—É–ø–ø—ã\\n\\n' +
      'üìå –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ—á–µ—Ç ID –≥—Ä—É–ø–ø—ã –∏–∑ —Å—Å—ã–ª–∫–∏',
      'https://vk.com/'
    );
    
    if (!vkUrl) return;
    
    const tgChatInput = prompt(
      'üí¨ –í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ Telegram –∫–∞–Ω–∞–ª:\\n\\n' +
      '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:\\n' +
      '‚Ä¢ https://t.me/–∏–º—è_–∫–∞–Ω–∞–ª–∞\\n' +
      '‚Ä¢ t.me/–∏–º—è_–∫–∞–Ω–∞–ª–∞\\n' +
      '‚Ä¢ @–∏–º—è_–∫–∞–Ω–∞–ª–∞\\n' +
      '‚Ä¢ –∏–º—è_–∫–∞–Ω–∞–ª–∞\\n' +
      '‚Ä¢ -1001234567890 (–µ—Å–ª–∏ –∑–Ω–∞–µ—Ç–µ chat_id)\\n\\n' +
      'üìå –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç chat_id –∫–∞–Ω–∞–ª–∞\\n\\n' +
      'üí° –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª:\\n' +
      '1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–Ω–∞–ª –≤ Telegram\\n' +
      '2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏–∑ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏\\n' +
      '3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–º—è –∫–∞–Ω–∞–ª–∞ –±–µ–∑ @',
      'https://t.me/'
    );
    
    if (!tgChatInput) return;
    
    showMessage('bindings', 'loading', 'üîÑ –°–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–∫–∏...');
    showLoader(true);
    
    google.script.run
      .withSuccessHandler(function(result) {
        showLoader(false);
        
        if (result.success) {
          showMessage('bindings', 'success', '‚úÖ –°–≤—è–∑–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!');
          loadBindings();
        } else {
          showMessage('bindings', 'error', result.error);
        }
      })
      .withFailureHandler(function(error) {
        showLoader(false);
        showMessage('bindings', 'error', '–û—à–∏–±–∫–∞: ' + error.message);
      })
      .addBinding(vkUrl, tgChatInput);
  }

  function editBinding(bindingId) {
    const binding = appState.bindings.find(b => b.id === bindingId);
    if (!binding) return;
    
    const newVkUrl = prompt(
      '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å VK –≥—Ä—É–ø–ø—É:\\n\\n' +
      '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:\\n' +
      '‚Ä¢ https://vk.com/–≥—Ä—É–ø–ø–∞\\n' +
      '‚Ä¢ https://vk.com/public123456\\n' +
      '‚Ä¢ vk.com/club123456',
      binding.vkGroupUrl
    );
    if (!newVkUrl) return;
    
    const newTgChatInput = prompt(
      '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å Telegram –∫–∞–Ω–∞–ª:\\n\\n' +
      '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:\\n' +
      '‚Ä¢ https://t.me/–∫–∞–Ω–∞–ª\\n' +
      '‚Ä¢ @–∏–º—è_–∫–∞–Ω–∞–ª–∞\\n' +
      '‚Ä¢ -1001234567890 (chat_id)',
      binding.tgChatId
    );
    if (!newTgChatInput) return;
    
    showMessage('bindings', 'loading', 'üîÑ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π...');
    showLoader(true);
    
    google.script.run
      .withSuccessHandler(function(result) {
        showLoader(false);
        
        if (result.success) {
          showMessage('bindings', 'success', '‚úÖ –°–≤—è–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
          loadBindings();
        } else {
          showMessage('bindings', 'error', result.error);
        }
      })
      .withFailureHandler(function(error) {
        showLoader(false);
        showMessage('bindings', 'error', '–û—à–∏–±–∫–∞: ' + error.message);
      })
      .editBinding(bindingId, newVkUrl, newTgChatInput);
  }

  function toggleBinding(bindingId) {
    const binding = appState.bindings.find(b => b.id === bindingId);
    if (!binding) return;
    
    const action = binding.status === 'active' ? '–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '–≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å';
    
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ' + action + ' —ç—Ç—É —Å–≤—è–∑–∫—É?')) return;
    
    showMessage('bindings', 'loading', 'üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞...');
    showLoader(true);
    
    google.script.run
      .withSuccessHandler(function(result) {
        showLoader(false);
        
        if (result.success) {
          showMessage('bindings', 'success', '‚úÖ –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "' + result.newStatus + '"');
          loadBindings();
        } else {
          showMessage('bindings', 'error', result.error);
        }
      })
      .withFailureHandler(function(error) {
        showLoader(false);
        showMessage('bindings', 'error', '–û—à–∏–±–∫–∞: ' + error.message);
      })
      .toggleBindingStatus(bindingId);
  }

  function deleteBinding(bindingId) {
    const binding = appState.bindings.find(b => b.id === bindingId);
    if (!binding) return;
    
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤—è–∑–∫—É?\\n\\n' + binding.vkGroupUrl + ' ‚Üí ' + binding.tgChatId)) return;
    
    showMessage('bindings', 'loading', 'üîÑ –£–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∫–∏...');
    showLoader(true);
    
    google.script.run
      .withSuccessHandler(function(result) {
        showLoader(false);
        
        if (result.success) {
          showMessage('bindings', 'success', '‚úÖ –°–≤—è–∑–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
          loadBindings();
        } else {
          showMessage('bindings', 'error', result.error);
        }
      })
      .withFailureHandler(function(error) {
        showLoader(false);
        showMessage('bindings', 'error', '–û—à–∏–±–∫–∞: ' + error.message);
      })
      .deleteBinding(bindingId);
  }

  function testBinding(bindingId) {
    const binding = appState.bindings.find(b => b.id === bindingId);
    if (!binding) return;
    
    if (!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Å—Ç –∏–∑ VK –≥—Ä—É–ø–ø—ã –≤ Telegram?\\n\\n–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–≤—è–∑–∫–∏.')) return;
    
    showMessage('bindings', 'loading', 'üß™ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞...');
    showLoader(true);
    
    google.script.run
      .withSuccessHandler(function(result) {
        showLoader(false);
        
        if (result.success) {
          showMessage('bindings', 'success', '‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.');
        } else {
          showMessage('bindings', 'error', '–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ' + result.error);
        }
      })
      .withFailureHandler(function(error) {
        showLoader(false);
        showMessage('bindings', 'error', '–û—à–∏–±–∫–∞: ' + error.message);
      })
      .testPublication(bindingId);
  }

  // ============================================
  // –£–¢–ò–õ–ò–¢–´
  // ============================================

  function showMessage(section, type, text) {
    const messageEl = document.getElementById(section + '-message');
    messageEl.className = 'message ' + type;
    messageEl.textContent = text;
    
    if (type !== 'loading') {
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 5000);
    }
  }

  function showLoader(show) {
    const loader = document.getElementById('loader');
    if (show) {
      loader.classList.add('show');
    } else {
      loader.classList.remove('show');
    }
  }
</script>
</body>
</html>`;
}

// ============================================
// 3. API FUNCTIONS (–°–ï–†–í–ï–†–ù–´–ï –í–´–ó–û–í–´)
// ============================================

function getInitialData() {
  try {
    const license = getLicense();
    const bindings = license ? getBindings().bindings || [] : [];
    
    return {
      success: true,
      license: license,
      bindings: bindings
    };
    
  } catch (error) {
    logEvent("ERROR", "get_initial_data", "client", error.message);
    return {
      success: false,
      error: error.message
    };
  }
}

function saveLicenseWithCheck(licenseKey) {
  try {
    if (SERVER_URL === "YOUR_SERVER_URL_HERE" || !SERVER_URL) {
      return {
        success: false,
        error: "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!\\n\\n–í–∞–º –Ω—É–∂–Ω–æ:\\n1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ Server.gs (–ø—É–Ω–∫—Ç '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞')\\n2. –í—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ –≤ Client.gs –≤ —Å—Ç—Ä–æ–∫—É: const SERVER_URL = \"–í–ê–®_URL_–ó–î–ï–°–¨\""
      };
    }
    
    logEvent("INFO", "license_check_start", "client", "Checking license: " + licenseKey.substring(0, 20) + "...");
    
    const response = UrlFetchApp.fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      payload: JSON.stringify({
        event: "check_license",
        license_key: licenseKey
      }),
      muteHttpExceptions: true,
      timeout: 30000
    });
    
    const result = JSON.parse(response.getContentText());
    
    if (result.success) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é –ª–æ–∫–∞–ª—å–Ω–æ
      PropertiesService.getUserProperties().setProperty("LICENSE_KEY", licenseKey);
      
      logEvent("INFO", "license_saved", "client", "License type: " + result.license.type);
      
      return {
        success: true,
        license: {
          key: licenseKey,
          type: result.license.type,
          maxGroups: result.license.maxGroups,
          expires: result.license.expires
        }
      };
    } else {
      logEvent("WARN", "license_check_failed", "client", result.error);
      return { success: false, error: result.error };
    }
    
  } catch (error) {
    logEvent("ERROR", "license_check_error", "client", error.message);
    return { success: false, error: error.message };
  }
}

function addBinding(vkGroupUrl, tgChatId) {
  try {
    const license = getLicense();
    if (!license) {
      return { success: false, error: "–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" };
    }
    
    logEvent("INFO", "add_binding_start", "client", vkGroupUrl + " ‚Üí " + tgChatId);
    
    const response = UrlFetchApp.fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      payload: JSON.stringify({
        event: "add_binding",
        license_key: license.key,
        vk_group_url: vkGroupUrl,
        tg_chat_id: tgChatId
      }),
      muteHttpExceptions: true,
      timeout: 30000
    });
    
    const result = JSON.parse(response.getContentText());
    
    if (result.success) {
      logEvent("INFO", "binding_added", "client", "Binding ID: " + result.binding_id);
    } else {
      logEvent("WARN", "add_binding_failed", "client", result.error);
    }
    
    return result;
    
  } catch (error) {
    logEvent("ERROR", "add_binding_error", "client", error.message);
    return { success: false, error: error.message };
  }
}

function editBinding(bindingId, vkGroupUrl, tgChatId) {
  try {
    const license = getLicense();
    if (!license) {
      return { success: false, error: "–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" };
    }
    
    const response = UrlFetchApp.fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      payload: JSON.stringify({
        event: "edit_binding",
        license_key: license.key,
        binding_id: bindingId,
        vk_group_url: vkGroupUrl,
        tg_chat_id: tgChatId
      }),
      muteHttpExceptions: true,
      timeout: 30000
    });
    
    const result = JSON.parse(response.getContentText());
    
    if (result.success) {
      logEvent("INFO", "binding_edited", "client", "Binding ID: " + bindingId);
    } else {
      logEvent("WARN", "edit_binding_failed", "client", result.error);
    }
    
    return result;
    
  } catch (error) {
    logEvent("ERROR", "edit_binding_error", "client", error.message);
    return { success: false, error: error.message };
  }
}

function deleteBinding(bindingId) {
  try {
    const license = getLicense();
    if (!license) {
      return { success: false, error: "–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" };
    }
    
    const response = UrlFetchApp.fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      payload: JSON.stringify({
        event: "delete_binding",
        license_key: license.key,
        binding_id: bindingId
      }),
      muteHttpExceptions: true,
      timeout: 30000
    });
    
    const result = JSON.parse(response.getContentText());
    
    if (result.success) {
      logEvent("INFO", "binding_deleted", "client", "Binding ID: " + bindingId);
    } else {
      logEvent("WARN", "delete_binding_failed", "client", result.error);
    }
    
    return result;
    
  } catch (error) {
    logEvent("ERROR", "delete_binding_error", "client", error.message);
    return { success: false, error: error.message };
  }
}

function getBindings() {
  try {
    const license = getLicense();
    if (!license) {
      return { success: false, error: "–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" };
    }
    
    const response = UrlFetchApp.fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      payload: JSON.stringify({
        event: "get_bindings",
        license_key: license.key
      }),
      muteHttpExceptions: true,
      timeout: 30000
    });
    
    return JSON.parse(response.getContentText());
    
  } catch (error) {
    logEvent("ERROR", "get_bindings_error", "client", error.message);
    return { success: false, error: error.message };
  }
}

function toggleBindingStatus(bindingId) {
  try {
    const license = getLicense();
    if (!license) {
      return { success: false, error: "–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" };
    }
    
    const response = UrlFetchApp.fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      payload: JSON.stringify({
        event: "toggle_binding_status",
        license_key: license.key,
        binding_id: bindingId
      }),
      muteHttpExceptions: true,
      timeout: 30000
    });
    
    const result = JSON.parse(response.getContentText());
    
    if (result.success) {
      logEvent("INFO", "binding_status_toggled", "client", "Binding ID: " + bindingId + ", New status: " + result.new_status);
    } else {
      logEvent("WARN", "toggle_status_failed", "client", result.error);
    }
    
    return result;
    
  } catch (error) {
    logEvent("ERROR", "toggle_status_error", "client", error.message);
    return { success: false, error: error.message };
  }
}

function testPublication(bindingId) {
  try {
    const license = getLicense();
    if (!license) {
      return { success: false, error: "–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" };
    }
    
    logEvent("INFO", "test_publication_start", "client", "Binding ID: " + bindingId);
    
    const response = UrlFetchApp.fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      payload: JSON.stringify({
        event: "test_publication",
        license_key: license.key,
        binding_id: bindingId
      }),
      muteHttpExceptions: true,
      timeout: 30000
    });
    
    const result = JSON.parse(response.getContentText());
    
    if (result.success) {
      logEvent("INFO", "test_publication_success", "client", "Binding ID: " + bindingId);
    } else {
      logEvent("WARN", "test_publication_failed", "client", result.error);
    }
    
    return result;
    
  } catch (error) {
    logEvent("ERROR", "test_publication_error", "client", error.message);
    return { success: false, error: error.message };
  }
}

// ============================================
// 4. –¢–†–ò–ì–ì–ï–† –ò –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê
// ============================================

function checkNewPostsManually() {
  const result = checkNewPosts();
  
  if (result.success) {
    SpreadsheetApp.getUi().alert(
      "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
      "–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Å–≤—è–∑–æ–∫: " + result.bindingsChecked + "\n" +
      "–ù–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ: " + result.newPostsFound + "\n" +
      "–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: " + result.postsSent + "\n\n" +
      "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –ª–æ–≥–∞—Ö."
    );
  } else {
    SpreadsheetApp.getUi().alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: " + result.error);
  }
}

function checkNewPosts() {
  try {
    logEvent("INFO", "check_posts_start", "client", "Manual/Trigger check started");
    
    const license = getLicense();
    if (!license) {
      return { success: false, error: "–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" };
    }
    
    const bindingsResult = getBindings();
    if (!bindingsResult.success) {
      return { success: false, error: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–≤—è–∑–∫–∏: " + bindingsResult.error };
    }
    
    const activeBindings = bindingsResult.bindings.filter(b => b.status === 'active');
    if (activeBindings.length === 0) {
      return { success: true, bindingsChecked: 0, newPostsFound: 0, postsSent: 0 };
    }
    
    let newPostsFound = 0;
    let postsSent = 0;
    
    for (const binding of activeBindings) {
      try {
        const vkGroupId = extractVkGroupId(binding.vkGroupUrl);
        if (!vkGroupId) {
          logEvent("WARN", "invalid_vk_url", "client", binding.vkGroupUrl);
          continue;
        }
        
        const posts = getVkPosts(vkGroupId);
        if (!posts || posts.length === 0) {
          continue;
        }
        
        const lastPostIds = getLastPostIds();
        const lastKnownId = lastPostIds[vkGroupId] || 0;
        
        const newPosts = posts.filter(post => post.id > lastKnownId);
        newPostsFound += newPosts.length;
        
        for (const post of newPosts) {
          if (isPostAlreadySent(vkGroupId, post.id)) {
            continue; // –î—É–±–ª—å
          }
          
          const sendResult = sendPostToServer(license.key, binding.id, post);
          
          if (sendResult.success) {
            markPostAsSent(vkGroupId, post.id, binding.tgChatId);
            postsSent++;
            logEvent("INFO", "post_sent", "client", `VK ${vkGroupId} Post ${post.id} ‚Üí TG ${binding.tgChatId}`);
          } else {
            logEvent("ERROR", "post_send_failed", "client", sendResult.error);
          }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π ID –ø–æ—Å—Ç–∞
        if (posts.length > 0) {
          lastPostIds[vkGroupId] = Math.max(...posts.map(p => p.id));
          saveLastPostIds(lastPostIds);
        }
        
      } catch (bindingError) {
        logEvent("ERROR", "binding_check_error", "client", "Binding " + binding.id + ": " + bindingError.message);
      }
    }
    
    logEvent("INFO", "check_posts_complete", "client", 
             `Checked: ${activeBindings.length}, Found: ${newPostsFound}, Sent: ${postsSent}`);
    
    return {
      success: true,
      bindingsChecked: activeBindings.length,
      newPostsFound: newPostsFound,
      postsSent: postsSent
    };
    
  } catch (error) {
    logEvent("ERROR", "check_posts_error", "client", error.message);
    return { success: false, error: error.message };
  }
}

function sendPostToServer(licenseKey, bindingId, vkPost) {
  try {
    logEvent("DEBUG", "send_post_to_server_start", "client", `Binding: ${bindingId}, Post ID: ${vkPost.id}, Text length: ${vkPost.text?.length || 0}, Attachments: ${vkPost.attachments?.length || 0}`);
    
    const payload = {
      event: "send_post",
      license_key: licenseKey,
      binding_id: bindingId,
      vk_post: {
        id: vkPost.id,
        text: vkPost.text?.substring(0, 100) + (vkPost.text?.length > 100 ? "..." : ""), // –°–æ–∫—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –ª–æ–≥–æ–≤
        date: vkPost.date,
        attachments: vkPost.attachments || []
      }
    };
    
    logEvent("DEBUG", "server_request_payload", "client", `Event: ${payload.event}, Payload size: ${JSON.stringify(payload).length} chars`);
    
    const response = UrlFetchApp.fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true,
      timeout: 30000
    });
    
    const responseText = response.getContentText();
    logEvent("DEBUG", "server_response", "client", `Status: ${response.getResponseCode()}, Body length: ${responseText.length}, First 150 chars: ${responseText.substring(0, 150)}`);
    
    const result = JSON.parse(responseText);
    
    if (result.success) {
      logEvent("INFO", "post_sent_successfully", "client", `Post ID: ${vkPost.id}, Message ID: ${result.message_id || 'unknown'}`);
    } else {
      logEvent("WARN", "post_send_failed_server", "client", `Post ID: ${vkPost.id}, Error: ${result.error}`);
    }
    
    return result;
    
  } catch (error) {
    logEvent("ERROR", "send_post_to_server_error", "client", `Post ID: ${vkPost.id}, Error: ${error.message}, Stack: ${error.stack?.substring(0, 200)}`);
    return { success: false, error: error.message };
  }
}

// ============================================
// 5. VK API –ò –£–¢–ò–õ–ò–¢–´
// ============================================

function getVkPosts(groupId) {
  try {
    const url = `https://api.vk.com/method/wall.get?owner_id=-${groupId}&count=10&v=5.131`;
    
    const response = UrlFetchApp.fetch(url, {
      muteHttpExceptions: true,
      timeout: 15000
    });
    
    const data = JSON.parse(response.getContentText());
    
    if (data.error) {
      logEvent("ERROR", "vk_api_error", "client", `Group ${groupId}: ${data.error.error_msg}`);
      return [];
    }
    
    if (!data.response || !data.response.items) {
      return [];
    }
    
    return data.response.items.map(post => ({
      id: post.id,
      text: post.text || "",
      date: post.date,
      attachments: post.attachments || []
    }));
    
  } catch (error) {
    logEvent("ERROR", "vk_posts_error", "client", `Group ${groupId}: ${error.message}`);
    return [];
  }
}

function extractVkGroupId(url) {
  try {
    // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª –∏ –¥–æ–º–µ–Ω
    url = url.replace(/https?:\/\/(www\.|m\.)?vk\.com\//, '');
    
    // –ß–∏—Å–ª–æ–≤–æ–π ID
    if (/^\d+$/.test(url)) {
      return url;
    }
    
    // public123456
    if (/^public\d+$/.test(url)) {
      return url.replace('public', '');
    }
    
    // club123456
    if (/^club\d+$/.test(url)) {
      return url.replace('club', '');
    }
    
    // –ö–æ—Ä–æ—Ç–∫–∏–π –∞–¥—Ä–µ—Å - –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
    const apiUrl = `https://api.vk.com/method/groups.getById?group_ids=${encodeURIComponent(url)}&v=5.131`;
    
    const response = UrlFetchApp.fetch(apiUrl, {
      muteHttpExceptions: true,
      timeout: 10000
    });
    
    const data = JSON.parse(response.getContentText());
    
    if (data.error || !data.response || !data.response[0]) {
      return null;
    }
    
    return data.response[0].id.toString();
    
  } catch (error) {
    logEvent("ERROR", "extract_group_id_error", "client", `URL: ${url}, Error: ${error.message}`);
    return null;
  }
}

// ============================================
// 6. –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–†–ò–ì–ì–ï–†–ê–ú–ò
// ============================================

function setupTrigger() {
  try {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã
    const triggers = ScriptApp.getProjectTriggers();
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'checkNewPosts') {
        ScriptApp.deleteTrigger(trigger);
      }
    });
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
    ScriptApp.newTrigger('checkNewPosts')
      .timeBased()
      .everyMinutes(30)
      .create();
    
    logEvent("INFO", "trigger_created", "client", "30-minute trigger created");
    
    SpreadsheetApp.getUi().alert(
      "‚úÖ –¢—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞–Ω!\n\n" +
      "–°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç.\n\n" +
      "–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n" +
      "‚Ä¢ VK‚ÜíTelegram > –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã –≤—Ä—É—á–Ω—É—é\n" +
      "‚Ä¢ –ö–Ω–æ–ø–∫—É \"–¢–µ—Å—Ç\" —É –∫–∞–∂–¥–æ–π —Å–≤—è–∑–∫–∏"
    );
    
  } catch (error) {
    logEvent("ERROR", "trigger_setup_error", "client", error.message);
    SpreadsheetApp.getUi().alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞: " + error.message);
  }
}

// ============================================
// 7. –•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• –ò –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
// ============================================

function getLicense() {
  try {
    const licenseKey = PropertiesService.getUserProperties().getProperty("LICENSE_KEY");
    if (!licenseKey) return null;
    
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–µ–Ω–∑–∏–∏
    return { key: licenseKey };
    
  } catch (error) {
    return null;
  }
}

function getLastPostIds() {
  try {
    const data = PropertiesService.getUserProperties().getProperty("LAST_POST_IDS");
    return data ? JSON.parse(data) : {};
  } catch (error) {
    return {};
  }
}

function saveLastPostIds(ids) {
  try {
    PropertiesService.getUserProperties().setProperty("LAST_POST_IDS", JSON.stringify(ids));
  } catch (error) {
    logEvent("ERROR", "save_last_ids_error", "client", error.message);
  }
}

function isPostAlreadySent(vkGroupId, postId) {
  try {
    const sheet = getOrCreatePublishedPostsSheet(vkGroupId);
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] == postId) {
        return true;
      }
    }
    
    return false;
  } catch (error) {
    return false;
  }
}

function markPostAsSent(vkGroupId, postId, tgChatId) {
  try {
    const sheet = getOrCreatePublishedPostsSheet(vkGroupId);
    sheet.appendRow([
      postId,
      new Date().toISOString(),
      tgChatId,
      "sent"
    ]);
  } catch (error) {
    logEvent("ERROR", "mark_post_sent_error", "client", error.message);
  }
}

function getOrCreatePublishedPostsSheet(vkGroupId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetName = `Published_${vkGroupId}`;
  let sheet = ss.getSheetByName(sheetName);
  
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    sheet.appendRow(["Post ID", "Sent At", "TG Chat ID", "Status"]);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    const headerRange = sheet.getRange(1, 1, 1, 4);
    headerRange.setBackground("#10b981");
    headerRange.setFontColor("white");
    headerRange.setFontWeight("bold");
    sheet.setFrozenRows(1);
    
    logEvent("INFO", "published_sheet_created", "client", "Sheet: " + sheetName);
  }
  
  return sheet;
}

function logEvent(level, event, source, details) {
  try {
    if (!DEV_MODE && level === "DEBUG") {
      return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º DEBUG –ª–æ–≥–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
    }
    
    const sheet = getOrCreateLogsSheet();
    sheet.appendRow([
      new Date().toISOString(),
      level,
      event,
      source,
      details || "",
      CLIENT_VERSION
    ]);
    
    // –¢–∞–∫–∂–µ –ª–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å
    console.log(`[${level}] ${event} (${source}): ${details}`);
    
  } catch (error) {
    console.error("Logging error:", error.message);
  }
}

function getOrCreateLogsSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName("Logs");
  
  if (!sheet) {
    sheet = ss.insertSheet("Logs");
    sheet.appendRow(["Timestamp", "Level", "Event", "Source", "Details", "Version"]);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    const headerRange = sheet.getRange(1, 1, 1, 6);
    headerRange.setBackground("#667eea");
    headerRange.setFontColor("white");
    headerRange.setFontWeight("bold");
    sheet.setFrozenRows(1);
  }
  
  return sheet;
}

// ============================================
// 8. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
// ============================================

function showUserStatistics() {
  try {
    const license = getLicense();
    if (!license) {
      SpreadsheetApp.getUi().alert("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
      return;
    }
    
    const bindingsResult = getBindings();
    const bindings = bindingsResult.success ? bindingsResult.bindings : [];
    
    const activeBindings = bindings.filter(b => b.status === 'active').length;
    const pausedBindings = bindings.filter(b => b.status === 'paused').length;
    
    // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ –ª–∏—Å—Ç–æ–≤ Published_*
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = ss.getSheets().filter(s => s.getName().startsWith('Published_'));
    let totalPostsSent = 0;
    
    sheets.forEach(sheet => {
      const data = sheet.getDataRange().getValues();
      totalPostsSent += Math.max(0, data.length - 1); // -1 –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
    });
    
    const today = new Date();
    const triggerCount = ScriptApp.getProjectTriggers()
      .filter(t => t.getHandlerFunction() === 'checkNewPosts').length;
    
    const message = `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ v${CLIENT_VERSION}\n\n` +
                   `üîó –°–≤—è–∑–∫–∏:\n` +
                   `‚Ä¢ –í—Å–µ–≥–æ: ${bindings.length}\n` +
                   `‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö: ${activeBindings}\n` +
                   `‚Ä¢ –ù–∞ –ø–∞—É–∑–µ: ${pausedBindings}\n\n` +
                   `üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:\n` +
                   `‚Ä¢ –í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${totalPostsSent}\n` +
                   `‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤: ${triggerCount}\n` +
                   `‚Ä¢ –õ–∏—Å—Ç–æ–≤ —Å –ø–æ—Å—Ç–∞–º–∏: ${sheets.length}\n\n` +
                   `üîß –°–µ—Ä–≤–µ—Ä: ${SERVER_URL === "YOUR_SERVER_URL_HERE" ? "‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω" : "‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω"}`;
    
    SpreadsheetApp.getUi().alert(message);
    
  } catch (error) {
    SpreadsheetApp.getUi().alert("‚ùå –û—à–∏–±–∫–∞: " + error.message);
  }
}

function showLogsSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let logsSheet = ss.getSheetByName("Logs");
  
  if (!logsSheet) {
    logsSheet = getOrCreateLogsSheet();
    SpreadsheetApp.getUi().alert("‚úÖ –õ–∏—Å—Ç 'Logs' —Å–æ–∑–¥–∞–Ω!\n\n–ó–¥–µ—Å—å –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∫–ª–∏–µ–Ω—Ç–∞.");
  }
  
  ss.setActiveSheet(logsSheet);
}

// ============================================
// –ö–û–ù–ï–¶ CLIENT.GS
// ============================================
