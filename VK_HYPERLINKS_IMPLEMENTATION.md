# VK→Telegram Crossposter - VK Hyperlinks Implementation

## Обзор

Реализована правильная обработка VK гиперссылок при переносе постов из VK в Telegram с сохранением форматирования и переносов строк.

## Проблема

1. **Удалялись переносы строк** - текст сливался в одну строку
2. **VK гиперссылки не обрабатывались** - формат `[URL|Текст]` показывался как сырой текст
3. **Использовался Markdown** вместо HTML для Telegram API

## Решение

### ✅ Реализовано:

1. **VK гиперссылки преобразуются в HTML:**
   - `[https://example.com|Текст ссылки]` → `<a href="https://example.com">Текст ссылки</a>`
   - `[id12345|Имя пользователя]` → `<a href="https://vk.com/id12345">Имя пользователя</a>`
   - `[club12345|Название клуба]` → `<a href="https://vk.com/club12345">Название клуба</a>`
   - `[public12345|Название паблика]` → `<a href="https://vk.com/public12345">Название паблика</a>`

2. **Сохранение переносов строк:**
   - Убрано удаление `\n` символов
   - Сохраняется оригинальное форматирование VK постов

3. **Переход на HTML форматирование:**
   - `parse_mode: 'HTML'` во всех функциях отправки Telegram
   - Жирный текст: `**текст**` → `<b>текст</b>`

## Измененные файлы

### 1. `/server/vk-posts.gs`
- **`formatVkTextForTelegram()`**: Полностью переработана для HTML форматирования
- **Порядок обработки**: Сначала специфичные VK ссылки, потом общие гиперссылки
- **Сохранение переносов строк**: Удалены `trim()` и сокращение `\n{3,}`

### 2. `/server.gs`
- **`sendTelegramMessage()`**: `parse_mode: 'HTML'` вместо `'Markdown'`
- **Логирование**: Обновлено для отражения HTML режима

### 3. `/server/telegram-service.gs`
- **`sendMediaGroupWithCaption()`**: `parse_mode: 'HTML'`
- **`sendTelegramVideo()`**: `parse_mode: 'HTML'`
- **`sendTelegramDocument()`**: уже использовал `parse_mode: 'HTML'`

### 4. `/tests/unit/vk-posts.test.js`
- **Обновлены тесты**: Проверка HTML форматирования вместо Markdown
- **Добавлены тесты**: 
  - VK гиперссылки в HTML
  - Сохранение переносов строк
  - Обработка club/public ссылок

## Регулярные выражения

### VK гиперссылки
```javascript
// Общие гиперссылки: [URL|Текст]
/\[([^\]|]+)\|([^\]]+)\]/g

// Пользователи: [id12345|Имя]
/\[id(\d+)\|(.+?)\]/g

// Группы: [club12345|Название] или [public12345|Название]
/\[(club|public)(\d+)\|(.+?)\]/g
```

## Примеры преобразования

| VK формат | Telegram HTML |
|-----------|---------------|
| `[https://example.com|Ссылка]` | `<a href="https://example.com">Ссылка</a>` |
| `[id12345|John Doe]` | `<a href="https://vk.com/id12345">John Doe</a>` |
| `[club12345|My Club]` | `<a href="https://vk.com/club12345">My Club</a>` |
| `[public12345|Public Page]` | `<a href="https://vk.com/public12345">Public Page</a>` |

## Тестирование

### Запуск тестов
```bash
npm test tests/unit/vk-posts.test.js
```

### Результаты
- ✅ 101 тест проходит
- ✅ Линтинг без ошибок
- ✅ Сборка успешна
- ✅ Module-check проходит

## Важные замечания

1. **Порядок обработки**: Сначала специфичные VK ссылки (id, club, public), потом общие гиперссылки
2. **Сохранение форматирования**: Переносы строк и пробелы сохраняются как в VK
3. **Обратная совместимость**: Старые посты без гиперссылок работают как раньше
4. **HTML валидация**: Все сгенерированные ссылки валидны для Telegram API

## CI/CD

Все изменения совместимы с существующей CI/CD инфраструктурой:
- Линтинг проходит
- Тесты проходят
- Сборка успешна
- Module-check подтверждает целостность VK модулей